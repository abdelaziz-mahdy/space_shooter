name: Claude Auto-Fix from Review

# This workflow automatically creates a PR with code fixes based on review comments.
#
# USAGE:
#   Method 1 (Automatic): Add a review comment with '@claude-fix' in the body
#   Method 2 (Manual): Go to Actions → "Claude Auto-Fix from Review" → Run workflow
#
# WHAT IT DOES:
#   1. Reads the original PR and review comments
#   2. Applies the suggested fixes following CLAUDE.md guidelines
#   3. Creates a new branch: fix/auto-fix-pr-{NUMBER}
#   4. Creates a new PR with the fixes
#   5. Links it back to the original PR
#
# REQUIREMENTS:
#   - CLAUDE_CODE_OAUTH_TOKEN secret must be set
#   - Repository needs write permissions for contents and pull-requests

on:
  pull_request_review:
    types: [submitted]
  # You can also trigger manually via workflow_dispatch
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to fix'
        required: true
        type: number

jobs:
  auto-fix:
    # Only run if the review contains a specific trigger phrase
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.review && contains(github.event.review.body, '@claude-fix'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to create branches
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git
        run: |
          git config user.name "claude-bot[bot]"
          git config user.email "claude-bot[bot]@users.noreply.github.com"

      - name: Get PR number
        id: pr-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Auto-Fix
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          additional_permissions: |
            actions: read
            contents: write
            pull-requests: write

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr-info.outputs.pr_number }}

            Please perform the following tasks:

            1. Read the original PR and all review comments using `gh pr view` and `gh pr diff`
            2. Analyze the review feedback and identify all suggested code changes
            3. Apply the fixes to the codebase following the project's CLAUDE.md guidelines
            4. Create a new branch named `fix/auto-fix-pr-${{ steps.pr-info.outputs.pr_number }}`
            5. Commit your changes with a descriptive message
            6. Create a new pull request with:
               - Title: "Auto-fix: Address review comments from PR #${{ steps.pr-info.outputs.pr_number }}"
               - Body that includes:
                 * Summary of changes made
                 * Reference to original PR
                 * List of review comments addressed
            7. Link the new PR to the original PR by commenting on the original PR

            IMPORTANT GUIDELINES:
            - Follow ALL coding principles in CLAUDE.md
            - If this is a client-facing change, update pubspec.yaml version and assets/changelog.json
            - Run tests if applicable
            - Only fix issues explicitly mentioned in the review
            - If you're unsure about a fix, ask for clarification in a comment instead

            Use these tools:
            - `gh pr view` to read PR details and reviews
            - `gh pr diff` to see the changes
            - Git commands to create branches and commits
            - `gh pr create` to create the fix PR
            - `gh pr comment` to communicate progress

          claude_args: '--allowedTools "Read,Write,Edit,Glob,Grep,Bash(gh:*),Bash(git:*)"'
